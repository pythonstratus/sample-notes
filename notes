# Databricks notebook source
from pyspark.sql.functions import *
from pyspark.sql.types import *

# COMMAND ----------
# Read large XML file using Spark XML reader
contract_df = spark.read \
    .format("xml") \
    .option("rootTag", "feed") \
    .option("rowTag", "ns0:entry") \
    .option("valueTag", "_value") \
    .option("attributePrefix", "_") \
    .load("/Volumes/tagging/fpds_raw/landing/fpds_output_2025-01-03.xml")

# COMMAND ----------
# Extract and transform the data with additional fields
processed_df = contract_df.select(
    # Basic Contract Information
    col("ns0:content.ns1:award.ns1:awardID.ns1:awardContractID.ns1:PIID").alias("piid"),
    col("ns0:content.ns1:award.ns1:awardID.ns1:awardContractID.ns1:agencyID._value").alias("agency_id"),
    col("ns0:content.ns1:award.ns1:awardID.ns1:awardContractID.ns1:agencyID._name").alias("agency_name"),
    col("ns0:content.ns1:award.ns1:awardID.ns1:awardContractID.ns1:modNumber").alias("mod_number"),
    
    # Dates
    col("ns0:content.ns1:award.ns1:relevantContractDates.ns1:signedDate").alias("signed_date"),
    col("ns0:content.ns1:award.ns1:relevantContractDates.ns1:effectiveDate").alias("effective_date"),
    col("ns0:content.ns1:award.ns1:relevantContractDates.ns1:currentCompletionDate").alias("completion_date"),
    col("ns0:content.ns1:award.ns1:relevantContractDates.ns1:ultimateCompletionDate").alias("ultimate_completion_date"),
    
    # Financial Information
    col("ns0:content.ns1:award.ns1:dollarValues.ns1:obligatedAmount").alias("obligated_amount"),
    col("ns0:content.ns1:award.ns1:dollarValues.ns1:baseAndExercisedOptionsValue").alias("base_and_exercised_options_value"),
    col("ns0:content.ns1:award.ns1:dollarValues.ns1:baseAndAllOptionsValue").alias("base_and_all_options_value"),
    col("ns0:content.ns1:award.ns1:totalDollarValues.ns1:totalObligatedAmount").alias("total_obligated_amount"),
    
    # Vendor Information
    col("ns0:content.ns1:award.ns1:vendor.ns1:vendorHeader.ns1:vendorName").alias("vendor_name"),
    col("ns0:content.ns1:award.ns1:vendor.ns1:vendorHeader.ns1:vendorAlternateName").alias("vendor_alternate_name"),
    col("ns0:content.ns1:award.ns1:vendor.ns1:vendorSiteDetails.ns1:vendorLocation.ns1:streetAddress").alias("street_address"),
    col("ns0:content.ns1:award.ns1:vendor.ns1:vendorSiteDetails.ns1:vendorLocation.ns1:city").alias("city"),
    col("ns0:content.ns1:award.ns1:vendor.ns1:vendorSiteDetails.ns1:vendorLocation.ns1:state._value").alias("state"),
    col("ns0:content.ns1:award.ns1:vendor.ns1:vendorSiteDetails.ns1:vendorLocation.ns1:ZIPCode._value").alias("zip_code"),
    col("ns0:content.ns1:award.ns1:vendor.ns1:vendorSiteDetails.ns1:vendorLocation.ns1:phoneNo").alias("phone_no"),
    
    # Contract Details
    col("ns0:content.ns1:award.ns1:contractData.ns1:contractActionType._value").alias("contract_action_type"),
    col("ns0:content.ns1:award.ns1:contractData.ns1:typeOfContractPricing._value").alias("contract_pricing_type"),
    col("ns0:content.ns1:award.ns1:contractData.ns1:nationalInterestActionCode._value").alias("national_interest_code"),
    col("ns0:content.ns1:award.ns1:contractData.ns1:descriptionOfContractRequirement").alias("contract_description"),
    
    # Product/Service Information
    col("ns0:content.ns1:award.ns1:productOrServiceInformation.ns1:productOrServiceCode._value").alias("product_service_code"),
    col("ns0:content.ns1:award.ns1:productOrServiceInformation.ns1:principalNAICSCode._value").alias("naics_code"),
    
    # Competition Information
    col("ns0:content.ns1:award.ns1:competition.ns1:extentCompeted._value").alias("extent_competed"),
    col("ns0:content.ns1:award.ns1:competition.ns1:solicitationProcedures._value").alias("solicitation_procedures"),
    col("ns0:content.ns1:award.ns1:competition.ns1:numberOfOffersReceived").alias("number_of_offers"),
    
    # Transaction Information
    col("ns0:content.ns1:award.ns1:transactionInformation.ns1:createdBy").alias("created_by"),
    col("ns0:content.ns1:award.ns1:transactionInformation.ns1:createdDate").alias("created_date"),
    col("ns0:content.ns1:award.ns1:transactionInformation.ns1:lastModifiedBy").alias("last_modified_by"),
    col("ns0:content.ns1:award.ns1:transactionInformation.ns1:lastModifiedDate").alias("last_modified_date"),
    
    # Additional Vendor Indicators
    col("ns0:content.ns1:award.ns1:vendor.ns1:vendorSiteDetails.ns1:vendorSocioEconomicIndicators.ns1:isSmallBusiness").alias("is_small_business"),
    col("ns0:content.ns1:award.ns1:vendor.ns1:vendorSiteDetails.ns1:vendorSocioEconomicIndicators.ns1:isVeteranOwned").alias("is_veteran_owned"),
    col("ns0:content.ns1:award.ns1:vendor.ns1:vendorSiteDetails.ns1:vendorSocioEconomicIndicators.ns1:isWomenOwned").alias("is_women_owned")
)

# Clean up the data
cleaned_df = processed_df \
    .withColumn("signed_date", to_timestamp("signed_date")) \
    .withColumn("effective_date", to_timestamp("effective_date")) \
    .withColumn("completion_date", to_timestamp("completion_date")) \
    .withColumn("ultimate_completion_date", to_timestamp("ultimate_completion_date")) \
    .withColumn("created_date", to_timestamp("created_date")) \
    .withColumn("last_modified_date", to_timestamp("last_modified_date")) \
    .withColumn("obligated_amount", col("obligated_amount").cast(DecimalType(18,2))) \
    .withColumn("base_and_exercised_options_value", col("base_and_exercised_options_value").cast(DecimalType(18,2))) \
    .withColumn("base_and_all_options_value", col("base_and_all_options_value").cast(DecimalType(18,2))) \
    .withColumn("total_obligated_amount", col("total_obligated_amount").cast(DecimalType(18,2))) \
    .withColumn("zip_code", trim(col("zip_code"))) \
    .withColumn("state", trim(col("state"))) \
    .withColumn("city", trim(col("city"))) \
    .withColumn("vendor_name", trim(col("vendor_name"))) \
    .withColumn("phone_no", trim(col("phone_no"))) \
    .withColumn("contract_description", trim(col("contract_description")))

# COMMAND ----------
display(cleaned_df)
