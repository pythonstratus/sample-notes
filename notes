# Databricks notebook source
from pyspark.sql.functions import *
from pyspark.sql.types import *

# COMMAND ----------
# Read large XML file using Spark XML reader
contract_df = spark.read \
    .format("xml") \
    .option("rootTag", "feed") \
    .option("rowTag", "ns0:entry") \
    .option("valueTag", "_value") \
    .option("attributePrefix", "_") \
    .load("/Volumes/tagging/fpds_raw/landing/fpds_output_2025-01-03.xml")

# COMMAND ----------
# Extract and transform the data with corrected paths
processed_df = contract_df.select(
    col("content.award.awardID.awardContractID.PIID").alias("piid"),
    col("content.award.awardID.awardContractID.agencyID").alias("agency_id"),
    col("content.award.awardID.awardContractID.agencyID._name").alias("agency_name"),
    col("content.award.relevantContractDates.signedDate").alias("signed_date"),
    col("content.award.relevantContractDates.effectiveDate").alias("effective_date"),
    col("content.award.dollarValues.obligatedAmount").alias("obligated_amount"),
    col("content.award.dollarValues.baseAndExercisedOptionsValue").alias("base_and_exercised_options_value"),
    col("content.award.vendor.vendorHeader.vendorName").alias("vendor_name"),
    col("content.award.vendor.vendorLocation.streetAddress").alias("street_address"),
    col("content.award.vendor.vendorLocation.city").alias("city"),
    col("content.award.vendor.vendorLocation.state").alias("state"),
    col("content.award.vendor.vendorLocation.ZIPCode").alias("zip_code")
)

# Clean up the data
cleaned_df = processed_df.withColumn("signed_date", to_timestamp("signed_date")) \
    .withColumn("effective_date", to_timestamp("effective_date")) \
    .withColumn("obligated_amount", col("obligated_amount").cast(DecimalType(18,2))) \
    .withColumn("base_and_exercised_options_value", col("base_and_exercised_options_value").cast(DecimalType(18,2))) \
    .withColumn("zip_code", trim(col("zip_code"))) \
    .withColumn("state", trim(col("state"))) \
    .withColumn("city", trim(col("city"))) \
    .withColumn("vendor_name", trim(col("vendor_name")))

# COMMAND ----------
display(cleaned_df)
