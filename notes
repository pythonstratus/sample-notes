from urllib.request import urlopen
import xml.etree.ElementTree as et
from datetime import datetime as dt
import os
import shutil

# Base paths setup - using exact paths from your code
BASE_PATH = '/Volumes/staging/fpds'
RAW_PATH = os.path.join(BASE_PATH, 'raw')

def create_dated_folders(date):
    """Create YYYY/MM folder structure and return the path"""
    year = date.strftime('%Y')
    month = date.strftime('%m')
    folder_path = os.path.join(RAW_PATH, year, month)
    os.makedirs(folder_path, exist_ok=True)
    return folder_path

def get_data():
    response_XML = ''
    request_Index = 0
    request_Increment = 10
    
    while True:
        request_URL = request_BaseURL + '%20LAST_MOD_DATE:[' + request_ModifiedDate + '],' + '&start=' + str(request_Index)
        print(request_URL)
        
        while True:
            try:
                response_XML = urlopen(request_URL).read()
                root = et.fromstring(response_XML)
                print('There was a successful response, batch: {}'.format(request_Index))
                break
            except Exception as e:
                print('There was an error during response, will try to request batch: {}'.format(request_Index))
                print(request_URL)
                continue
        
        for entry in root.findall('{http://www.w3.org/2005/Atom}entry'):
            entry_XML = et.tostring(entry)
            yield entry_XML
        
        if root.findall('{http://www.w3.org/2005/Atom}entry') == []:
            break
        else:
            request_Index = request_Index + request_Increment

def write_data():
    current_date = dt.now()
    folder_path = create_dated_folders(current_date)
    
    destination_folder = '/Volumes/staging/fpds_raw/landing/fpds/'
    destination_folder2 = '/Volumes/staging/fpds_raw/landing/fpds/' + dt.now().strftime("%Y-%m-%d") + '_fpds_output.xml'
    file_output_path = os.path.join(folder_path, 'fpds_output_' + dt.now().strftime("%Y-%m-%d") + '.xml')
    
    output_file = open(file_output_path, 'w')
    output_file.write("<feed>")
    
    for entry_XML in get_data():
        output_file.write(entry_XML.decode("utf-8"))
    
    output_file.write("</feed>")
    output_file.close()
    
    # Correct shutil operations exactly as in your code
    shutil.copy(file_output_path, destination_folder)
    shutil.copy(file_output_path, destination_folder2)

def main():
    global request_BaseURL, request_ModifiedDate
    
    request_BaseURL = 'https://www.fpds.gov/dbsight/FEEDS/ATOM?templateName=1.5.3&FEEDNAME=PUBLIC&q=FUNDING_AGENCY_ID:"9555"'
    request_ModifiedDate = '2010/01/01'
    
    os.makedirs(RAW_PATH, exist_ok=True)
    write_data()

if __name__ == "__main__":
    main()
